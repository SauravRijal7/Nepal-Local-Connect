<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Dashboard - Nepal Local Connect</title>
    <link rel="stylesheet" href="org_dashboard.css">
</head>
<body>
    <div class="container">
        <h2 id="welcome-msg">Welcome, Organization</h2>

        <h3>Add Your Business</h3>
        <form id="business-form">
            <input type="text" id="title" placeholder="Business Title" required>
            <textarea id="description" placeholder="Business Description" required></textarea>
            <input type="file" id="image" accept="image/*" required>
            <button type="submit">Publish</button>
        </form>
        <p id="msg" class="message"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC_dRLjrZnMVg9XJNXrIHwJQ054TaV6a1U",
            authDomain: "nepal-local-connect-16e2b.firebaseapp.com",
            projectId: "nepal-local-connect-16e2b",
            storageBucket: "nepal-local-connect-16e2b.appspot.com",
            messagingSenderId: "174039102881",
            appId: "1:174039102881:web:b483996d60febdf7c847e0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const welcomeMsg = document.getElementById('welcome-msg');
        const businessForm = document.getElementById('business-form');
        const msg = document.getElementById('msg');

        // Check if user is logged in and fetch org name
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (!userDoc.exists() || userDoc.data().type !== "organization") {
                    alert("Access denied. Not an organization.");
                    window.location.href = "org_login.html";
                    return;
                }
                welcomeMsg.textContent = `Welcome, ${userDoc.data().name}`;
            } else {
                window.location.href = "org_login.html";
            }
        });

        // Publish business
        businessForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const imageFile = document.getElementById('image').files[0];

            if (!imageFile) {
                msg.style.color = "red";
                msg.textContent = "Please select an image.";
                return;
            }

            try {
                const user = auth.currentUser;

                // Upload image to Firebase Storage
                const storageRef = ref(storage, `business_images/${user.uid}_${Date.now()}_${imageFile.name}`);
                await uploadBytes(storageRef, imageFile);
                const imageUrl = await getDownloadURL(storageRef);

                // Add business to Firestore
                await addDoc(collection(db, "businesses"), {
                    ownerUid: user.uid,
                    title,
                    description,
                    imageUrl,
                    createdAt: new Date(),
                    ratingAverage: 0
                });

                msg.style.color = "green";
                msg.textContent = "Business published successfully!";
                businessForm.reset();

            } catch (error) {
                msg.style.color = "red";
                msg.textContent = error.message;
            }
        });
    </script>
</body>
</html>
