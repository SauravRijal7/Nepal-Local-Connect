<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Organization Dashboard - Nepal Local Connect</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Inter', sans-serif;
  background: #f8f9fb;
  margin: 0;
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* Sidebar */
.sidebar {
  width: 250px;
  background: #1f1f1f;
  color: #fff;
  display: flex;
  flex-direction: column;
  padding: 20px;
}

.sidebar h2 {
  font-size: 20px;
  margin-bottom: 30px;
  text-align: center;
}

.sidebar a {
  color: #ddd;
  text-decoration: none;
  margin: 10px 0;
  padding: 10px 14px;
  border-radius: 6px;
  transition: 0.2s;
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
}

.sidebar a:hover,
.sidebar a.active {
  background: #3a3a3a;
  color: #fff;
}

/* Main content */
.main {
  flex: 1;
  padding: 30px;
  overflow-y: auto;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
}

.header h2 {
  color: #222;
  font-size: 26px;
  font-weight: 600;
}

button.logout-btn {
  background: #e53e3e;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.3s;
}
button.logout-btn:hover {
  background: #c53030;
}

/* Dashboard card */
.dashboard-card {
  background: #fff;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 5px 18px rgba(0,0,0,0.08);
  margin-bottom: 30px;
}

.dashboard-card h3 {
  color: #333;
  margin-bottom: 20px;
}

form {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

input[type="text"],
input[type="file"],
textarea {
  padding: 12px 15px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 14px;
}

textarea { resize: vertical; min-height: 90px; }

button.publish-btn {
  background: #2563eb;
  color: white;
  border: none;
  padding: 12px;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s;
}
button.publish-btn:hover { background: #1e40af; }

.message { text-align: center; font-weight: 500; margin-top: 10px; }

/* View sections */
.view-section {
  display: none;
}

.view-section.active {
  display: block;
}

.no-business {
  text-align: center;
  padding: 40px;
  color: #666;
}

.business-info {
  background: #f9fafb;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
}

.business-info p {
  margin: 10px 0;
  color: #444;
}

.business-info img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin-top: 15px;
  max-height: 300px;
  object-fit: cover;
}

.review-item {
  padding: 15px;
  border-bottom: 1px solid #e5e7eb;
  background: #fafafa;
  margin-bottom: 10px;
  border-radius: 6px;
}

.review-item:last-child {
  border-bottom: none;
}

.rating-stars {
  color: #f59e0b;
  font-size: 18px;
  margin-bottom: 5px;
}

.no-reviews {
  text-align: center;
  padding: 20px;
  color: #888;
}

.action-buttons {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}

.edit-btn, .delete-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: 0.3s;
}

.edit-btn {
  background: #2563eb;
  color: white;
}

.edit-btn:hover {
  background: #1e40af;
}

.delete-btn {
  background: #e53e3e;
  color: white;
}

.delete-btn:hover {
  background: #c53030;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: white;
  padding: 30px;
  border-radius: 12px;
  max-width: 500px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-content h3 {
  margin-top: 0;
  margin-bottom: 20px;
}

.modal-buttons {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}

.cancel-btn {
  background: #6b7280;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

.cancel-btn:hover {
  background: #4b5563;
}

.confirm-btn {
  background: #e53e3e;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

.confirm-btn:hover {
  background: #c53030;
}

#edit-image-preview {
  max-width: 200px;
  margin-top: 10px;
  border-radius: 6px;
}
</style>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Local Connect</h2>
    <a href="#" class="nav-link active" data-view="dashboard">üìä Dashboard</a>
    <a href="#" class="nav-link" data-view="add-business">‚ûï Add Business</a>
    <a href="#" class="nav-link" data-view="reviews">‚≠ê Reviews</a>
    <a href="#" id="logout">üö™ Logout</a>
  </div>

  <!-- Main Content -->
  <div class="main">
    <div class="header">
      <h2 id="welcome-msg">Welcome, Organization</h2>
      <button class="logout-btn" id="logout-btn">Logout</button>
    </div>

    <!-- Dashboard View -->
    <div class="view-section active" id="dashboard-view">
      <div class="dashboard-card">
        <h3>Your Business Overview</h3>
        <div id="dashboard-content">
          <p class="no-business">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Add Business View -->
    <div class="view-section" id="add-business-view">
      <div class="dashboard-card">
        <h3>Add Your Business</h3>
        <div id="add-business-content">
          <form id="business-form">
            <input type="text" id="title" placeholder="Business Title" required>
            <input type="text" id="type" placeholder="Business Type (e.g., Restaurant, Shop, Service)" required>
            <input type="text" id="contact" placeholder="Contact Number" required>
            <input type="file" id="businessImage" accept="image/*" />
            <textarea id="description" placeholder="Business Description" required></textarea>
            <button type="submit" class="publish-btn">Publish Business</button>
          </form>
          <p id="msg" class="message"></p>
        </div>
      </div>
    </div>

    <!-- Reviews View -->
    <div class="view-section" id="reviews-view">
      <div class="dashboard-card">
        <h3>User Ratings & Comments</h3>
        <div id="reviews-content">
          <p class="no-reviews">Loading reviews...</p>
        </div>
      </div>
    </div>

  </div>

  <!-- Edit Modal -->
  <div class="modal" id="edit-modal">
    <div class="modal-content">
      <h3>Edit Your Business</h3>
      <form id="edit-form">
        <input type="text" id="edit-title" placeholder="Business Title" required>
        <input type="text" id="edit-type" placeholder="Business Type" required>
        <input type="text" id="edit-contact" placeholder="Contact Number" required>
        <textarea id="edit-description" placeholder="Business Description" required></textarea>
        <input type="file" id="edit-image" accept="image/*" />
        <p style="font-size:12px; color:#666;">Leave image empty to keep current image</p>
        <img id="edit-image-preview" style="display:none;" />
        <div class="modal-buttons">
          <button type="button" class="cancel-btn" id="cancel-edit">Cancel</button>
          <button type="submit" class="publish-btn">Save Changes</button>
        </div>
      </form>
      <p id="edit-msg" class="message"></p>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal" id="delete-modal">
    <div class="modal-content">
      <h3>Delete Business</h3>
      <p>Are you sure you want to delete your business? This action cannot be undone.</p>
      <div class="modal-buttons">
        <button type="button" class="cancel-btn" id="cancel-delete">Cancel</button>
        <button type="button" class="confirm-btn" id="confirm-delete">Delete</button>
      </div>
      <p id="delete-msg" class="message"></p>
    </div>
  </div>

<script type="module">
import { getStorage, ref, uploadBytes, getDownloadURL } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import { 
  getFirestore, doc, getDoc, collection, addDoc, 
  query, where, getDocs, deleteDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyC_dRLjrZnMVg9XJNXrIHwJQ054TaV6a1U",
  authDomain: "nepal-local-connect-16e2b.firebaseapp.com",
  projectId: "nepal-local-connect-16e2b",
  storageBucket: "nepal-local-connect-16e2b.appspot.com",
  messagingSenderId: "174039102881",
  appId: "1:174039102881:web:b483996d60febdf7c847e0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const welcomeMsg = document.getElementById('welcome-msg');
const businessForm = document.getElementById('business-form');
const msg = document.getElementById('msg');
const logoutBtn = document.getElementById('logout-btn');

let currentBusiness = null;
let currentBusinessId = null;

// Navigation functionality
const navLinks = document.querySelectorAll('.nav-link');
const viewSections = document.querySelectorAll('.view-section');

navLinks.forEach(link => {
  link.addEventListener('click', (e) => {
    e.preventDefault();
    const viewName = link.getAttribute('data-view');
    
    // Update active nav link
    navLinks.forEach(l => l.classList.remove('active'));
    link.classList.add('active');
    
    // Show corresponding view
    viewSections.forEach(section => section.classList.remove('active'));
    document.getElementById(`${viewName}-view`).classList.add('active');
  });
});

// üîê AUTH CHECK
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "org_login.html";
    return;
  }

  const userDoc = await getDoc(doc(db, "users", user.uid));
  if (!userDoc.exists() || userDoc.data().type !== "organization") {
    alert("Access denied.");
    window.location.href = "org_login.html";
    return;
  }

  welcomeMsg.textContent = `Welcome, ${userDoc.data().name}`;

  // ‚úÖ CHECK IF BUSINESS ALREADY EXISTS
  const qBiz = query(collection(db, "businesses"), where("ownerUid", "==", user.uid));
  const bizSnap = await getDocs(qBiz);

  if (!bizSnap.empty) {
    currentBusiness = bizSnap.docs[0].data();
    currentBusinessId = bizSnap.docs[0].id;
    
    loadDashboard();
    loadReviews();
    
    // Hide add business form and show message
    document.getElementById('add-business-content').innerHTML = `
      <p style="text-align:center; color:#666; padding:40px;">
        ‚úÖ You have already published a business. View it in the Dashboard section.
      </p>
    `;
  } else {
    // No business yet
    document.getElementById('dashboard-content').innerHTML = `
      <p class="no-business">You haven't published a business yet. Click "Add Business" to get started.</p>
    `;
    document.getElementById('reviews-content').innerHTML = `
      <p class="no-reviews">No reviews yet. Publish your business first to receive reviews.</p>
    `;
  }
});

// Load Dashboard Content
function loadDashboard() {
  if (!currentBusiness) return;
  
  const html = `
    <div class="business-info">
      <p><strong>üìå Business Title:</strong> ${currentBusiness.title}</p>
      <p><strong>üè¢ Business Type:</strong> ${currentBusiness.type}</p>
      <p><strong>üìû Contact:</strong> ${currentBusiness.contact}</p>
      <p><strong>üìù Description:</strong> ${currentBusiness.description}</p>
      <p><strong>‚≠ê Average Rating:</strong> ${currentBusiness.ratingAverage || 0}/5</p>
      ${currentBusiness.businessurl ? `<img src="${currentBusiness.businessurl}" alt="Business Image" />` : ''}
      <div class="action-buttons">
        <button class="edit-btn" id="edit-business-btn">‚úèÔ∏è Edit Business</button>
        <button class="delete-btn" id="delete-business-btn">üóëÔ∏è Delete Business</button>
      </div>
    </div>
  `;
  
  document.getElementById('dashboard-content').innerHTML = html;
  
  // Attach event listeners
  document.getElementById('edit-business-btn').addEventListener('click', openEditModal);
  document.getElementById('delete-business-btn').addEventListener('click', openDeleteModal);
}

// Load Reviews
async function loadReviews() {
  if (!currentBusinessId) return;
  
  const reviewQuery = query(collection(db, "reviews"), where("businessId", "==", currentBusinessId));
  const reviewSnap = await getDocs(reviewQuery);

  if (reviewSnap.empty) {
    document.getElementById('reviews-content').innerHTML = `
      <p class="no-reviews">No reviews yet. Users will be able to review your business once it's published.</p>
    `;
    return;
  }

  let output = "";
  reviewSnap.forEach(r => {
    const data = r.data();
    const stars = "‚≠ê".repeat(data.rating) + "‚òÜ".repeat(5 - data.rating);
    output += `
      <div class="review-item">
        <div class="rating-stars">${stars} (${data.rating}/5)</div>
        <p style="color:#555; margin:5px 0;">${data.comment}</p>
      </div>
    `;
  });

  document.getElementById('reviews-content').innerHTML = output;
}

// ‚úÖ LOGOUT
logoutBtn.addEventListener("click", async () => {
  await signOut(auth);
  window.location.href = "org_login.html";
});

document.getElementById('logout').addEventListener("click", async (e) => {
  e.preventDefault();
  await signOut(auth);
  window.location.href = "org_login.html";
});

// ‚úÖ SUBMIT BUSINESS
businessForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const title = document.getElementById('title').value.trim();
  const type = document.getElementById('type').value.trim();
  const contact = document.getElementById('contact').value.trim();
  const description = document.getElementById('description').value.trim();
  const file = document.getElementById('businessImage').files[0];

  try {
    const user = auth.currentUser;

    // ‚úÖ Check if user already posted business
    const q = query(collection(db, "businesses"), where("ownerUid", "==", user.uid));
    const snap = await getDocs(q);

    if (!snap.empty) {
      msg.style.color = "red";
      msg.textContent = "‚ùå You can only publish one business.";
      return;
    }

    let imageUrl = "";

    // ‚úÖ Upload image if selected
    if (file) {
      msg.textContent = "Uploading image...";
      const storageRef = ref(storage, "businessImages/" + Date.now() + "_" + file.name);
      await uploadBytes(storageRef, file);
      imageUrl = await getDownloadURL(storageRef);
    }

    msg.textContent = "Publishing business...";

    await addDoc(collection(db, "businesses"), {
      ownerUid: user.uid,
      title,
      type,
      contact,
      description,
      businessurl: imageUrl,
      createdAt: new Date(),
      ratingAverage: 0
    });

    msg.style.color = "green";
    msg.textContent = "‚úÖ Business published successfully! Redirecting...";
    businessForm.reset();
    setTimeout(() => location.reload(), 1500);

  } catch (err) {
    msg.style.color = "red";
    msg.textContent = "‚ùå Error: " + err.message;
  }
});

// Edit Modal Functions
function openEditModal() {
  document.getElementById('edit-title').value = currentBusiness.title;
  document.getElementById('edit-type').value = currentBusiness.type;
  document.getElementById('edit-contact').value = currentBusiness.contact;
  document.getElementById('edit-description').value = currentBusiness.description;
  
  if (currentBusiness.businessurl) {
    document.getElementById('edit-image-preview').src = currentBusiness.businessurl;
    document.getElementById('edit-image-preview').style.display = 'block';
  }
  
  document.getElementById('edit-modal').classList.add('active');
}

document.getElementById('cancel-edit').addEventListener('click', () => {
  document.getElementById('edit-modal').classList.remove('active');
  document.getElementById('edit-msg').textContent = '';
});

document.getElementById('edit-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const editMsg = document.getElementById('edit-msg');
  const title = document.getElementById('edit-title').value.trim();
  const type = document.getElementById('edit-type').value.trim();
  const contact = document.getElementById('edit-contact').value.trim();
  const description = document.getElementById('edit-description').value.trim();
  const file = document.getElementById('edit-image').files[0];
  
  try {
    editMsg.textContent = "Updating business...";
    editMsg.style.color = "#2563eb";
    
    let imageUrl = currentBusiness.businessurl;
    
    // Upload new image if selected
    if (file) {
      editMsg.textContent = "Uploading new image...";
      const storageRef = ref(storage, "businessImages/" + Date.now() + "_" + file.name);
      await uploadBytes(storageRef, file);
      imageUrl = await getDownloadURL(storageRef);
    }
    
    // Update Firestore document
    await updateDoc(doc(db, "businesses", currentBusinessId), {
      title,
      type,
      contact,
      description,
      businessurl: imageUrl,
      updatedAt: new Date()
    });
    
    editMsg.style.color = "green";
    editMsg.textContent = "‚úÖ Business updated successfully! Refreshing...";
    
    setTimeout(() => location.reload(), 1500);
    
  } catch (err) {
    editMsg.style.color = "red";
    editMsg.textContent = "‚ùå Error: " + err.message;
  }
});

// Delete Modal Functions
function openDeleteModal() {
  document.getElementById('delete-modal').classList.add('active');
}

document.getElementById('cancel-delete').addEventListener('click', () => {
  document.getElementById('delete-modal').classList.remove('active');
  document.getElementById('delete-msg').textContent = '';
});

document.getElementById('confirm-delete').addEventListener('click', async () => {
  const deleteMsg = document.getElementById('delete-msg');
  
  try {
    deleteMsg.textContent = "Deleting business...";
    deleteMsg.style.color = "#2563eb";
    
    // Delete the business document
    await deleteDoc(doc(db, "businesses", currentBusinessId));
    
    deleteMsg.style.color = "green";
    deleteMsg.textContent = "‚úÖ Business deleted successfully! Redirecting...";
    
    setTimeout(() => location.reload(), 1500);
    
  } catch (err) {
    deleteMsg.style.color = "red";
    deleteMsg.textContent = "‚ùå Error: " + err.message;
  }
});
</script>
</body>
</html>