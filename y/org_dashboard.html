<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Organization Dashboard - Nepal Local Connect</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --primary: #E74C3C;
  --primary-dark: #C0392B;
  --primary-light: #FF6B6B;
  --secondary: #2C3E50;
  --secondary-light: #34495E;
  --accent: #F39C12;
  --accent-light: #F1C40F;
  --bg-primary: #000000;
  --bg-secondary: #F8F9FA;
  --bg-dark: #1A1A2E;
  --text-primary: #2C3E50;
  --text-secondary: #7F8C8D;
  --text-light: #BDC3C7;
}

* {
  box-sizing: border-box;
}

body {
  font-family: 'Inter', sans-serif;
  background: lavenderblush;
 /* background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);*/
  margin: 0;
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* Sidebar */
.sidebar {
  width: 250px;
  background: rgba(26, 26, 46, 0.95);
  backdrop-filter: blur(10px);
  color: #000000;
  display: flex;
  flex-direction: column;
  padding: 20px;
  border-right: 1px solid rgba(255, 255, 255, 0.1);
}

.sidebar h2 {
  font-size: 22px;
  margin-bottom: 30px;
  text-align: center;
  background: linear-gradient(135deg, var(--primary-light), var(--accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-weight: 700;
}

.sidebar a {
  color: var(--text-light);
  text-decoration: none;
  margin: 10px 0;
  padding: 12px 16px;
  border-radius: 12px;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.sidebar a::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: -1;
}

.sidebar a:hover::before,
.sidebar a.active::before {
  opacity: 0.2;
}

.sidebar a:hover,
.sidebar a.active {
  color: #fff;
  transform: translateX(5px);
  background: rgba(255, 255, 255, 0.05);
}

/* Main content */
.main {
  flex: 1;
  padding: 30px;
  overflow-y: auto;
  background: rgba(255, 255, 255, 0.05);
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  padding: 20px;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(20px);
  border-radius: 16px;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.header h2 {
  color: #000000;
  font-size: 26px;
  font-weight: 600;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
  margin: 0;
}

button.logout-btn {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: rgb(0, 0, 0);
  border: none;
  padding: 10px 20px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-weight: 600;
  box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
}

button.logout-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
}

/* Dashboard card */
.dashboard-card {
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(20px);
  padding: 30px;
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  margin-bottom: 30px;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.dashboard-card h3 {
  color: #fff;
  margin-bottom: 25px;
  margin-top: 0;
  font-size: 22px;
  font-weight: 700;
}

form {
  display: flex;
  flex-direction: column;
  gap: 18px;
}

input[type="text"],
input[type="file"],
select,
textarea {
  padding: 14px 18px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  background: rgba(255, 255, 255, 0.9);
  border-radius: 12px;
  font-size: 14px;
  transition: all 0.3s ease;
  color: var(--text-primary);
}

input[type="text"]:focus,
select:focus,
textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.2);
  background: rgba(255, 255, 255, 1);
}

select {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%232C3E50' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 15px center;
  padding-right: 40px;
}

textarea { 
  resize: vertical; 
  min-height: 100px;
  font-family: 'Inter', sans-serif;
}

button.publish-btn {
  background: linear-gradient(135deg, var(--accent), var(--accent-light));
  color: white;
  border: none;
  padding: 14px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
}

button.publish-btn:hover { 
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
}

.message { 
  text-align: center; 
  font-weight: 600; 
  margin-top: 10px;
  color: #fff;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* View sections */
.view-section {
  display: none;
}

.view-section.active {
  display: block;
}

.no-business {
  text-align: center;
  padding: 40px;
  color: rgba(255, 255, 255, 0.8);
  font-size: 16px;
}

/* Modern Business Info Layout */
.business-info {
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(15px);
  padding: 0;
  border-radius: 20px;
  margin-bottom: 20px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  overflow: hidden;
  display: grid;
  grid-template-columns: 450px 1fr;
  gap: 0;
  min-height: 500px;
}

.business-image-section {
  position: relative;
  overflow: hidden;
}

.business-info img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.no-image-placeholder {
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 120px;
  color: rgba(255, 255, 255, 0.3);
}

.business-details-section {
  padding: 40px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.business-info-item {
  margin-bottom: 25px;
}

.business-info-item:last-child {
  margin-bottom: 0;
}

.business-info-label {
  color: rgba(7, 0, 0, 0.7);
  font-size: 20px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
  display: block;
}

.business-info-value {
  color: #000000;
  font-size: 20px;
  font-weight: 600;
  line-height: 1.6;
}

.business-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  margin-top: 30px;
  padding-top: 30px;
  border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.stat-box {
  text-align: center;
  padding: 20px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  backdrop-filter: blur(10px);
}

.stat-icon {
  font-size: 32px;
  margin-bottom: 8px;
}

.stat-value {
  font-size: 28px;
  font-weight: 700;
  color: var(--accent-light);
  margin-bottom: 5px;
}

.stat-label {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.7);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.action-buttons {
  display: flex;
  gap: 12px;
  margin-top: 30px;
}

.edit-btn, .delete-btn {
  padding: 14px 28px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-size: 15px;
  font-weight: 600;
  transition: all 0.3s ease;
  flex: 1;
}

.edit-btn {
  background: linear-gradient(135deg, var(--accent), var(--accent-light));
  color: white;
  box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
}

.edit-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
}

.delete-btn {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
}

.delete-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(8px);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  padding: 35px;
  border-radius: 20px;
  max-width: 500px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.modal-content h3 {
  margin-top: 0;
  margin-bottom: 25px;
  color: var(--text-primary);
  font-weight: 700;
  font-size: 24px;
}

.modal-content p {
  color: var(--text-secondary);
  line-height: 1.6;
}

.modal-buttons {
  display: flex;
  gap: 12px;
  margin-top: 25px;
}

.cancel-btn {
  background: linear-gradient(135deg, var(--secondary), var(--secondary-light));
  color: white;
  padding: 12px 24px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
  flex: 1;
  box-shadow: 0 4px 15px rgba(44, 62, 80, 0.3);
}

.cancel-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(44, 62, 80, 0.4);
}

.confirm-btn {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  padding: 12px 24px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
  flex: 1;
  box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
}

.confirm-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
}

#edit-image-preview {
  max-width: 200px;
  margin-top: 15px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  border: 2px solid rgba(243, 156, 18, 0.3);
}

.image-note {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 6px;
  font-style: italic;
}

/* Scrollbar styling */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.3);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.5);
}

/* Responsive */
@media (max-width: 1024px) {
  .business-info {
    grid-template-columns: 1fr;
    min-height: auto;
  }
  
  .business-image-section {
    height: 250px;
  }
  
  .business-stats {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 768px) {
  .sidebar {
    width: 200px;
  }
  
  .business-stats {
    grid-template-columns: 1fr;
  }
}
</style>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>🏔️ Local Connect</h2>
    <a href="#" class="nav-link active" data-view="dashboard">📊 Dashboard</a>
    <a href="#" class="nav-link" data-view="add-business">➕ Add Business</a>
    <a href="#" id="logout">🚪 Logout</a>
  </div>

  <!-- Main Content -->
  <div class="main">
    <div class="header">
      <h2 id="welcome-msg">Welcome, Organization</h2>
      <button class="logout-btn" id="logout-btn">Logout</button>
    </div>

    <!-- Dashboard View -->
    <div class="view-section active" id="dashboard-view">
      <div class="dashboard-card">
        <h3 style="color: black;">Your Business Overview</h3>
        <div id="dashboard-content">
          <p class="no-business">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Add Business View -->
    <div class="view-section" id="add-business-view">
      <div class="dashboard-card">
        <h3 style="color: black;">Add Your Business</h3>
        <div id="add-business-content">
          <form id="business-form">
            <input type="text" id="title" placeholder="Business Title" required>
            <select id="type" required>
              <option value="" disabled selected>Select Business Type</option>
              <option value="Restaurant">Restaurant</option>
              <option value="Homestay">Homestay</option>
              <option value="Trekking">Trekking</option>
              <option value="Hotel">Hotel</option>
              <option value="Adventure">Adventure</option>
            </select>
            <input type="text" id="contact" placeholder="Contact Number" required>
            <input type="file" id="businessImage" accept="image/*" />
            <p class="image-note">📌 Recommended: Images under 500KB for best performance</p>
            <textarea id="description" placeholder="Business Description" required></textarea>
            <button type="submit" class="publish-btn">Publish Business</button>
          </form>
          <p id="msg" class="message"></p>
        </div>
      </div>
    </div>

  </div>

  <!-- Edit Modal -->
  <div class="modal" id="edit-modal">
    <div class="modal-content">
      <h3>Edit Your Business</h3>
      <form id="edit-form">
        <input type="text" id="edit-title" placeholder="Business Title" required>
        <select id="edit-type" required>
          <option value="" disabled>Select Business Type</option>
          <option value="Restaurant">Restaurant</option>
          <option value="Homestay">Homestay</option>
          <option value="Trekking">Trekking</option>
          <option value="Hotel">Hotel</option>
          <option value="Adventure">Adventure</option>
        </select>
        <input type="text" id="edit-contact" placeholder="Contact Number" required>
        <textarea id="edit-description" placeholder="Business Description" required></textarea>
        <input type="file" id="edit-image" accept="image/*" />
        <p class="image-note">Leave empty to keep current image. Recommended: under 500KB</p>
        <img id="edit-image-preview" style="display:none;" />
        <div class="modal-buttons">
          <button type="button" class="cancel-btn" id="cancel-edit">Cancel</button>
          <button type="submit" class="publish-btn">Save Changes</button>
        </div>
      </form>
      <p id="edit-msg" class="message" style="color: var(--text-primary);"></p>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal" id="delete-modal">
    <div class="modal-content">
      <h3>Delete Business</h3>
      <p>Are you sure you want to delete your business? This action cannot be undone.</p>
      <div class="modal-buttons">
        <button type="button" class="cancel-btn" id="cancel-delete">Cancel</button>
        <button type="button" class="confirm-btn" id="confirm-delete">Delete</button>
      </div>
      <p id="delete-msg" class="message" style="color: var(--text-primary);"></p>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import { 
  getFirestore, doc, getDoc, collection, addDoc, 
  query, where, getDocs, deleteDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyC_dRLjrZnMVg9XJNXrIHwJQ054TaV6a1U",
  authDomain: "nepal-local-connect-16e2b.firebaseapp.com",
  projectId: "nepal-local-connect-16e2b",
  storageBucket: "nepal-local-connect-16e2b.appspot.com",
  messagingSenderId: "174039102881",
  appId: "1:174039102881:web:b483996d60febdf7c847e0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const welcomeMsg = document.getElementById('welcome-msg');
const businessForm = document.getElementById('business-form');
const msg = document.getElementById('msg');
const logoutBtn = document.getElementById('logout-btn');

let currentBusiness = null;
let currentBusinessId = null;

// Helper: Convert image to Base64
function convertToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = (error) => reject(error);
    reader.readAsDataURL(file);
  });
}

// Navigation functionality
const navLinks = document.querySelectorAll('.nav-link');
const viewSections = document.querySelectorAll('.view-section');

navLinks.forEach(link => {
  link.addEventListener('click', (e) => {
    e.preventDefault();
    const viewName = link.getAttribute('data-view');
    
    // Update active nav link
    navLinks.forEach(l => l.classList.remove('active'));
    link.classList.add('active');
    
    // Show corresponding view
    viewSections.forEach(section => section.classList.remove('active'));
    document.getElementById(`${viewName}-view`).classList.add('active');
  });
});

// 🔐 AUTH CHECK
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "org_login.html";
    return;
  }

  const userDoc = await getDoc(doc(db, "users", user.uid));
  if (!userDoc.exists() || userDoc.data().type !== "organization") {
    alert("Access denied.");
    window.location.href = "org_login.html";
    return;
  }

  welcomeMsg.textContent = `Welcome, ${userDoc.data().name}`;

  // ✅ CHECK IF BUSINESS ALREADY EXISTS
  const qBiz = query(collection(db, "businesses"), where("ownerUid", "==", user.uid));
  const bizSnap = await getDocs(qBiz);

  if (!bizSnap.empty) {
    currentBusiness = bizSnap.docs[0].data();
    currentBusinessId = bizSnap.docs[0].id;
    
    loadDashboard();
    
    // Hide add business form and show message
    document.getElementById('add-business-content').innerHTML = `
      <p style="text-align:center; color:black; padding:40px;">
        ✅ You have already published a business. View it in the Dashboard section.
      </p>
    `;
  } else {
    // No business yet
    document.getElementById('dashboard-content').innerHTML = `
      <p class="no-business">You haven't published a business yet. Click "Add Business" to get started.</p>
    `;
  }
});

// Load Dashboard Content
function loadDashboard() {
  if (!currentBusiness) return;
  
  const likes = currentBusiness.likes || 0;
  const dislikes = currentBusiness.dislikes || 0;
  const popularityScore = likes - dislikes;
  
  const imageHTML = currentBusiness.businessurl 
    ? `<img src="${currentBusiness.businessurl}" alt="${currentBusiness.title}" />`
    : `<div class="no-image-placeholder">🏢</div>`;
  
  const html = `
    <div class="business-info">
      <div class="business-image-section">
        ${imageHTML}
      </div>
      <div class="business-details-section">
        <div>
          <div class="business-info-item">
            <span class="business-info-label">📌 Business Title</span>
            <div class="business-info-value">${currentBusiness.title}</div>
          </div>
          
          <div class="business-info-item">
            <span class="business-info-label">🏢 Business Type</span>
            <div class="business-info-value">${currentBusiness.type}</div>
          </div>
          
          <div class="business-info-item">
            <span class="business-info-label">📞 Contact</span>
            <div class="business-info-value">${currentBusiness.contact}</div>
          </div>
          
          <div class="business-info-item">
            <span class="business-info-label">📝 Description</span>
            <div class="business-info-value" style="font-size: 16px; font-weight: 400; line-height: 1.8;">${currentBusiness.description}</div>
          </div>

          <div class="business-stats">
            <div class="stat-box">
              <div class="stat-icon">👍</div>
              <div class="stat-value">${likes}</div>
              <div class="stat-label">Likes</div>
            </div>
            <div class="stat-box">
              <div class="stat-icon">👎</div>
              <div class="stat-value">${dislikes}</div>
              <div class="stat-label">Dislikes</div>
            </div>
            <div class="stat-box">
              <div class="stat-icon">⭐</div>
              <div class="stat-value">${popularityScore >= 0 ? '+' : ''}${popularityScore}</div>
              <div class="stat-label">Score</div>
            </div>
          </div>
        </div>
        
        <div class="action-buttons">
          <button class="edit-btn" id="edit-business-btn">✏️ Edit Business</button>
          <button class="delete-btn" id="delete-business-btn">🗑️ Delete Business</button>
        </div>
      </div>
    </div>
  `;
  
  document.getElementById('dashboard-content').innerHTML = html;
  
  // Attach event listeners
  document.getElementById('edit-business-btn').addEventListener('click', openEditModal);
  document.getElementById('delete-business-btn').addEventListener('click', openDeleteModal);
}

// ✅ LOGOUT
logoutBtn.addEventListener("click", async () => {
  await signOut(auth);
  window.location.href = "org_login.html";
});

document.getElementById('logout').addEventListener("click", async (e) => {
  e.preventDefault();
  await signOut(auth);
  window.location.href = "org_login.html";
});

// ✅ SUBMIT BUSINESS
businessForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const title = document.getElementById('title').value.trim();
  const type = document.getElementById('type').value.trim();
  const contact = document.getElementById('contact').value.trim();
  const description = document.getElementById('description').value.trim();
  const file = document.getElementById('businessImage').files[0];

  try {
    const user = auth.currentUser;

    // ✅ Check if user already posted business
    const q = query(collection(db, "businesses"), where("ownerUid", "==", user.uid));
    const snap = await getDocs(q);

    if (!snap.empty) {
      msg.style.color = "red";
      msg.textContent = "❌ You can only publish one business.";
      return;
    }

    let imageBase64 = "";

    // ✅ Convert image to Base64 if selected
    if (file) {
      msg.textContent = "Processing image...";
      msg.style.color = "#fff";
      
      // Validate file size (max 1MB for Base64)
      if (file.size > 1 * 1024 * 1024) {
        throw new Error("Image size must be less than 1MB");
      }
      
      // Validate file type
      if (!file.type.startsWith('image/')) {
        throw new Error("Please select a valid image file");
      }
      
      imageBase64 = await convertToBase64(file);
      console.log("Image converted to Base64");
    }

    msg.textContent = "Publishing business...";

    await addDoc(collection(db, "businesses"), {
      ownerUid: user.uid,
      title,
      type,
      contact,
      description,
      businessurl: imageBase64,
      createdAt: new Date(),
      likes: 0,
      dislikes: 0
    });

    msg.style.color = "#4ade80";
    msg.textContent = "✅ Business published successfully! Redirecting...";
    businessForm.reset();
    setTimeout(() => location.reload(), 1500);

  } catch (err) {
    console.error("Submit error:", err);
    msg.style.color = "#f87171";
    msg.textContent = "❌ Error: " + err.message;
  }
});

// Edit Modal Functions
function openEditModal() {
  document.getElementById('edit-title').value = currentBusiness.title;
  document.getElementById('edit-type').value = currentBusiness.type;
  document.getElementById('edit-contact').value = currentBusiness.contact;
  document.getElementById('edit-description').value = currentBusiness.description;
  
  if (currentBusiness.businessurl) {
    document.getElementById('edit-image-preview').src = currentBusiness.businessurl;
    document.getElementById('edit-image-preview').style.display = 'block';
  }
  
  document.getElementById('edit-modal').classList.add('active');
}

document.getElementById('cancel-edit').addEventListener('click', () => {
  document.getElementById('edit-modal').classList.remove('active');
  document.getElementById('edit-msg').textContent = '';
});

document.getElementById('edit-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const editMsg = document.getElementById('edit-msg');
  const title = document.getElementById('edit-title').value.trim();
  const type = document.getElementById('edit-type').value.trim();
  const contact = document.getElementById('edit-contact').value.trim();
  const description = document.getElementById('edit-description').value.trim();
  const file = document.getElementById('edit-image').files[0];
  
  try {
    let imageBase64 = currentBusiness.businessurl || "";
    
    // Convert new image if selected
    if (file) {
      editMsg.textContent = "Processing new image...";
      editMsg.style.color = "var(--text-primary)";
      
      // Validate file size (max 1MB)
      if (file.size > 1 * 1024 * 1024) {
        throw new Error("Image size must be less than 1MB");
      }
      
      // Validate file type
      if (!file.type.startsWith('image/')) {
        throw new Error("Please select a valid image file");
      }
      
      imageBase64 = await convertToBase64(file);
      console.log("New image converted to Base64");
    }
    
    editMsg.textContent = "Updating business details...";
    
    // Update Firestore document - preserve likes and dislikes
    await updateDoc(doc(db, "businesses", currentBusinessId), {
      title,
      type,
      contact,
      description,
      businessurl: imageBase64,
      updatedAt: new Date()
    });
    
    editMsg.style.color = "#4ade80";
    editMsg.textContent = "✅ Business updated successfully! Refreshing...";
    
    setTimeout(() => location.reload(), 1500);
    
  } catch (err) {
    console.error("Edit form error:", err);
    editMsg.style.color = "#f87171";
    editMsg.textContent = "❌ Error: " + err.message;
  }
});

// Delete Modal Functions
function openDeleteModal() {
  document.getElementById('delete-modal').classList.add('active');
}

document.getElementById('cancel-delete').addEventListener('click', () => {
  document.getElementById('delete-modal').classList.remove('active');
  document.getElementById('delete-msg').textContent = '';
});

document.getElementById('confirm-delete').addEventListener('click', async () => {
  const deleteMsg = document.getElementById('delete-msg');
  
  try {
    deleteMsg.textContent = "Deleting business...";
    deleteMsg.style.color = "var(--text-primary)";
    
    // Delete the business document
    await deleteDoc(doc(db, "businesses", currentBusinessId));
    
    deleteMsg.style.color = "#4ade80";
    deleteMsg.textContent = "✅ Business deleted successfully! Redirecting...";
    
    setTimeout(() => location.reload(), 1500);
    
  } catch (err) {
    deleteMsg.style.color = "#f87171";
    deleteMsg.textContent = "❌ Error: " + err.message;
  }
});
</script>
</body>
</html>