<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Our Partners - Nepal Local Connect</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="partners.js"></script>
<style>
body {
  font-family: 'Inter', sans-serif;
  background: #f4f7f8;
  margin: 0;
  padding: 0;
}

.container {
  max-width: 1200px;
  margin: 40px auto;
  padding: 0 20px;
}

h1 {
  text-align: center;
  margin-bottom: 30px;
  color: #222;
}

.business-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 25px;
}

.business-card {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.1);
  overflow: hidden;
  transition: transform 0.2s;
}

.business-card:hover {
  transform: translateY(-5px);
}

.business-card img {
  width: 100%;
  height: 200px;
  object-fit: cover;
  background: #e5e7eb;
}

.card-content {
  padding: 20px;
}

.card-content h3 {
  margin: 0 0 10px 0;
  font-size: 20px;
  color: #111;
}

.card-content p {
  margin: 8px 0;
  color: #555;
  font-size: 14px;
  line-height: 1.5;
}

.rating {
  display: flex;
  align-items: center;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #e5e7eb;
}

.star {
  font-size: 22px;
  color: #d1d5db;
  cursor: pointer;
  margin-right: 3px;
  transition: color 0.2s;
}

.star.selected {
  color: #facc15;
}

.star:hover {
  color: #fbbf24;
}

.rating-text {
  margin-left: 10px;
  font-size: 14px;
  color: #666;
}

.message {
  text-align: center;
  color: green;
  margin-top: 20px;
  font-weight: 500;
  font-size: 16px;
}

.no-image {
  width: 100%;
  height: 200px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 48px;
}

.loading {
  text-align: center;
  padding: 40px;
  color: #666;
}
</style>
</head>
<body>
<div class="container">
  <h1>Our Partners</h1>
  <!-- Filters -->
  <div class="filters">
    <label>Type:
      <select id="typeFilter">
        <option value="">All</option>
        <option value="Restaurant">Restaurant</option>
        <option value="Shop">Shop</option>
        <option value="Hotel">Hotel</option>
      </select>
    </label>

    <label>Location:
      <select id="locationFilter">
        <option value="">All</option>
        <option value="Kathmandu">Kathmandu</option>
        <option value="Pokhara">Pokhara</option>
        <option value="Thamel">Thamel</option>
        <option value="Chitwan">Chitwan</option>
        <option value="Everest">Everest</option>
      </select>
    </label>

    <label>Min Rating:
      <select id="ratingFilter">
        <option value="0">All</option>
        <option value="1">1+</option>
        <option value="2">2+</option>
        <option value="3">3+</option>
        <option value="4">4+</option>
        <option value="5">5</option>
      </select>
    </label>

    <button id="applyFilters">Apply Filters</button>
  </div>

  <div class="business-grid" id="business-grid">
    <p class="loading">Loading businesses...</p>
  </div>
  <p id="msg" class="message"></p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyC_dRLjrZnMVg9XJNXrIHwJQ054TaV6a1U",
  authDomain: "nepal-local-connect-16e2b.firebaseapp.com",
  projectId: "nepal-local-connect-16e2b",
  storageBucket: "nepal-local-connect-16e2b.appspot.com",
  messagingSenderId: "174039102881",
  appId: "1:174039102881:web:b483996d60febdf7c847e0"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const businessGrid = document.getElementById('business-grid');
const msg = document.getElementById('msg');

// Fetch all businesses
async function loadBusinesses() {
  try {
    const querySnapshot = await getDocs(collection(db, "businesses"));
    
    if (querySnapshot.empty) {
      businessGrid.innerHTML = "<p class='loading'>No businesses found yet.</p>";
      return;
    }
    
    businessGrid.innerHTML = "";
    
    querySnapshot.forEach(docSnap => {
      const data = docSnap.data();
      const card = document.createElement('div');
      card.className = "business-card";
      
      // Get the correct image URL field (businessurl from your dashboard)
      const imageHTML = data.businessurl 
        ? `<img src="${data.businessurl}" alt="${data.title}" />` 
        : `<div class="no-image">üè¢</div>`;
      
      card.innerHTML = `
        ${imageHTML}
        <div class="card-content">
          <h3>${data.title || "Untitled Business"}</h3>
          <p><strong>Type:</strong> ${data.type || "N/A"}</p>
          <p><strong>Contact:</strong> ${data.contact || "N/A"}</p>
          <p><strong>Description:</strong> ${data.description || "No description provided"}</p>
          
          <div class="rating" data-id="${docSnap.id}">
            ${renderStars(data.ratingAverage || 0)}
            <span class="rating-text">${(data.ratingAverage || 0).toFixed(1)}/5</span>
          </div>
        </div>
      `;
      
      businessGrid.appendChild(card);

      // Add click event for rating
      const stars = card.querySelectorAll('.star');
      stars.forEach((star, index) => {
        star.addEventListener('click', async () => {
          const newRating = index + 1;
          try {
            // Update the rating in Firebase
            await updateDoc(doc(db, "businesses", docSnap.id), { 
              ratingAverage: newRating 
            });
            
            msg.textContent = `‚úÖ You rated ${data.title} ${newRating} star(s)!`;
            msg.style.color = "green";
            
            // Refresh the display
            setTimeout(() => {
              msg.textContent = "";
              loadBusinesses();
            }, 2000);
            
          } catch (err) {
            msg.textContent = `‚ùå Error: ${err.message}`;
            msg.style.color = "red";
          }
        });
      });
    });
  } catch (error) {
    businessGrid.innerHTML = `<p class='loading' style='color:red;'>Error loading businesses: ${error.message}</p>`;
  }
}

// Helper: render stars HTML
function renderStars(rating) {
  let html = '';
  const fullStars = Math.floor(rating);
  
  for(let i = 1; i <= 5; i++) {
    html += `<span class="star ${i <= fullStars ? 'selected' : ''}">‚òÖ</span>`;
  }
  return html;
}

// Load businesses on page load
loadBusinesses();
</script>
</body>
</html>